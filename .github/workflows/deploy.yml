name: Deploy Lovedoll Theme to freya-era.com

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # Remote directory 作成（存在してもOK）
      - name: Create remote theme directory
        run: |
          ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "mkdir -p public_html/freya-era.com/wp-content/themes/lovedoll-theme"

      - name: Deploy theme to freya-era.com
        uses: wlixcc/SFTP-Deploy-Action@v1.2.6
        with:
          server: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}

          # GitHubリポジトリのテーマファイルがある場所
          # ルート直下なら ./ のままでOK。サブフォルダなら ./lovedoll-theme/ に変更
          local_path: ./

          # freya-era.com 用の正しいパス
          remote_path: public_html/freya-era.com/wp-content/themes/lovedoll-theme/

          sftp_only: true
          delete_remote_files: false
          rsyncArgs: "--exclude='.git/' --exclude='.github/' --exclude='node_modules/' --exclude='.env' --exclude='.DS_Store' --exclude='*.py'"
